# dwld-bot

Микросервис управления ботом

<b>Тезисы:</b>  <br>
1. Это бот для телеграмма, соединяет интерфейс пользователя и скачивальщик (bff)    <br>
2. Локально держит базу с ссылками, качеством скачивния, датой отправки в скачивальщик (будущая отправка), id пользовтаеля(добавивший очередь), id сообщения от сервера (для последующего удаления) и сообщением о вставке  <br>
3. Каждые N секунд бот проходит  по базе с ссылками, если время подошло, то отправляется в скачивальщик <br>
4. Если вставка не удалась (в локальную очередь), то отрпавляется сразу в скачивальщик    <br>
5. Если вставка в скачивальщик провалилась, то ссылка снова возвращается в очередь вставки (увеличивая время вставки), ошибка записывается в базу  <br>
6. Пока запись не отправилась, пользователь может задать качество скачивания через бота (клавитура для сообщения)<br>
7. Качество по-умолчанию задается конфигом <br>
8. Пользователь может наблюдать и управлять только своими ссылками <br>
9. Поддержка разграничения прав пользователя. Админ оперирует всеми ссылками    <br>
10. Так же держит grpc сервер, скачивальщик должен сам "регистрироваться" в боте  <br>
11. База ботов - таблица с именем и адресами. Если при регистрации имя совпадает, то данные полностью обновляются  <br>
12. Каждое взаимодействие со скачивалщиком - обновляет соединение для актуализции и своевременной смены адресов  <br>
13. Успешно отправленные ссылки удаляются из базы  <br>
14. Выполенение маршрутизации ссылок на основе имени сервера и части адреса ссылки  <br>
14. Удаление сообщений с ссылками и клавитурой, которые уже отправлены <br>
15. Если подходящих серверов несколько, то отправка осуществляется последовательно, при возникновение ошибок в преыдущей отправке, но базовая очередь выбирается случайно  <br>


<br>
<b>STAGE 1 (COMPLETE):</b><br>
[+] Накидать архитектуру кода<br>
[+] Накидать контракты сервера (grpc)<br>
[+] Накидать конфиги<br>
[+] Реализовать работу с конфигами<br>
[+] Реализовать работу с базой<br>
[+] Реализовать работу со скачивальщиками<br>
[+] Накидать контракты для usecases<br>
[+] Реализовать контракты сервера (grpc)<br>
[+] Реализовать работу со списком ссылок (автораскидывание)<br>
[+] Реализовать контракты для usecases<br>
[+] Реализовать мандатную систему<br>
[+] Реализовать работу с телеграммом (База crud + sensors)<br>
[+] Реализовать работу с клавитурой телеграмма и ссылками на скачивание<br>
[+] Подключить необходимое в app<br>
[+] Реализовать регистрацию скачивальщиков с ботом<br>
[+] Тестирование полной связки со скачивальщиками<br>

<br>
<b>STAGE 2:</b><br>
[-] Сортировать в выдаче ссылки по статусу работы<br>
[-] Добавить готовые скрипты для автозапуска через systemd<br>
[-] Написать подробный гайд по запуску этой всей истории <br>
[-] Переименовать UserID в ChatID<br>
[-] Внедрить логгер <br>
[-] Добавить pprof <br>
[-] Рефаторинг (имена) <br>
    [-] target_quantity -> target_quality<br>
[-] Рефаторинг (абстракции) <br>
[-] Рефаторинг (типы) <br>
[-] Рефаторинг (логика) <br>
[-] Рефаторинг (лишние запросы (все)) <br>
[-] Добавить в бот (со стороны телеги) функцию автоудаления <br>